#!/usr/bin/env bash

# =========================================================================================== #
#: Title           : HistLog                                                                  #
#: Sypnosis        : HistLog                                                                  #
#: Date Created    : Sun Jul 27 18:07:40 PHT 2014 / Sun Jul 27 10:08:00 UTC 2014              #
#: Last Edit       : Mon Jan 19 12:41:39 PHT 2015 / Mon Jan 19 04:41:39 UTC 2015              #
#: License         : GPLv3                                                                    #
#: Version         : 1.0                                                                      #
#: Author          : Jason V. Ferrer '<jetchisel@opensuse.org>'                               #
#: Description     : Logs ~/.bash_history to ~/.bash_history.archive  after 10000 lines.      #
#: Options         : NONE                                                                     #
#: Home Page       : NONE                                                                     #
#: ExtComm         : ed                                                                       #
# =========================================================================================== #

# ******************************************************************************************** #
#                                                                                              #
#    Log everything to the desired log file. (NOTE: Builtins only on this part to be safe)     #
#                                                                                              #
# ******************************************************************************************** #

Date=$(printf "[%(%h %d %Y %H:%M:%S)T]" -1)
Log=$HOME/.HistLog

exec > >(
  while read -r line; do
    echo "$Date $line" >> "$Log"
  done
) 2>&1

# ******************************************************************************************** #
#                                                                                              #
#     Set the PATH just to be safe and cron will not complain about "command not found".       #
#                                                                                              #
# ******************************************************************************************** #

PATH=/usr/local/bin:/usr/bin:/bin
export PATH

# ******************************************************************************************* #
#                                                                                             #
#                                  The dashes variable.                                       #
#                                                                                             #
# ******************************************************************************************* #

Length=92
printf -v Line '#%*s#' "$Length"

# ******************************************************************************************* #
#                                                                                             #
#                             Define bash_history log file.                                   #
#                                                                                             #
# ******************************************************************************************* #

SourceFile=${HOME}/.bash_history

# ******************************************************************************************* #
#                                                                                             #
#                           Total lines of bash_history LogFile                               #
#                                                                                             #
# ******************************************************************************************* #

Total_Lines=$(printf '%s\n' '$=' | ed -s "$SourceFile")

# ******************************************************************************************* #
#                                                                                             #
#        Function to Cut from .bash_history and paste to .bash_history.archive                #
#                                                                                             #
# ******************************************************************************************* #

CutAndPaste() {
ed -s /home/jetchisel/.bash_history <<'EOF'
10001,$d
w
u
1,10000d
.- r /home/jetchisel/.bash_history.archive
w /home/jetchisel/.bash_history.archive
EOF
}

# ******************************************************************************************* #
#                                                                                             #
# If Total_lines is more than 10000, log to archive and delete the excess from SourceFile.    #
#                                                                                             #
# ******************************************************************************************* #

if (( Total_Lines > 10000 )); then
  printf '%s\n' "You have reached 10000 lines limit, moving the rest to ${SourceFile}.archive."
  CutAndPaste
else
  printf '%s\n' "Your history is only [${Total_Lines}] lines. Keep it comming!"
fi

# ******************************************************************************************* #
#                                                                                             #
#                                    Set the exit status.                                     #
#                                                                                             #
# ******************************************************************************************* #

exit 0

# =========================================================================================== #
#                                                                                             #
#                                    >>> END OF SCRIPT <<<                                    #
#                                                                                             #
# =========================================================================================== #

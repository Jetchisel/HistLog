#!/usr/bin/env bash

# =========================================================================================== #
#: Title           : HistLog                                                                  #
#: Sypnosis        : HistLog                                                                  #
#: Date Created    : Sun Jul 27 18:07:40 PHT 2014 / Sun Jul 27 10:08:00 UTC 2014              #
#: Last Edit       : Wed Aug 20 06:37:02 PHT 2014 / Tue Aug 19 22:37:02 UTC 2014              #
#: License         : GPLv3                                                                    #
#: Version         : 1.0                                                                      #
#: Author          : Jason V. Ferrer '<jetchisel@opensuse.org>'                               #
#: Description     : Logs ~/.bash_history to ~/.bash_history.archive  after 10000 lines.      #
#: Options         : NONE                                                                     #
#: Home Page       : NONE                                                                     #
#: ExtComm         : ed                                                                       #       
# =========================================================================================== #

# ******************************************************************************************* #
#                                                                                             #
#                                  The dashes variable.                                       #
#                                                                                             #
# ******************************************************************************************* #

Length=92
printf -v Line '#%*s#' "$Length"

# ******************************************************************************************* #
#                                                                                             #
#                          Print the starting message and date.                               #
#                                                                                             #
# ******************************************************************************************* #

printf '%s\n' "${Line// /=}" "Starting Histlog at <$(date)>"

# ******************************************************************************************* #
#                                                                                             #
#                             Define bash_history log file.                                   #
#                                                                                             #
# ******************************************************************************************* #

SourceFile=${HOME}/.bash_history

# ******************************************************************************************* #
#                                                                                             #
#                           Total lines of bash_history LogFile                               #
#                                                                                             #
# ******************************************************************************************* #

Total_Lines=$(printf '%s\n' '$=' | ed -s "$SourceFile")

# ******************************************************************************************* #
#                                                                                             #
#        Function to Cut from .bash_history and paste to .bash_history.archive                #
#                                                                                             #
# ******************************************************************************************* #

CutAndPaste() {
ed -s /home/jetchisel/.bash_history <<'EOF'
10001,$d
w
u
1,10000d
.- r /home/jetchisel/.bash_history.archive
w /home/jetchisel/.bash_history.archive
EOF
}

# ******************************************************************************************* #
#                                                                                             #
# If Total_lines is more than 10000, log to archive and delete the excess from SourceFile.    #
#                                                                                             #
# ******************************************************************************************* #

if (( Total_Lines > 10000 )); then
  printf '%s\n' "You have reached 10000 lines limit, moving the rest to ${SourceFile}.archive."
  CutAndPaste
else
  printf '%s\n' "Your history is only [${Total_Lines}] lines. Keep it comming!"  
fi

# ******************************************************************************************* #
#                                                                                             #
#                      Print the finishing message and date when fihished.                    #
#                                                                                             #
# ******************************************************************************************* #

printf '%s\n' "Finishing HistLog at <$(date)>"

# ******************************************************************************************* #
#                                                                                             #
#                                    Set the exit status.                                     #
#                                                                                             #
# ******************************************************************************************* #

exit 0

# =========================================================================================== #
#                                                                                             # 
#                                    >>> END OF SCRIPT <<<                                    #
#                                                                                             #
# =========================================================================================== # 
